#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program   = require('commander'),
    util      = require('util'),
    fs        = require('fs'),
    path      = require('path'),
    dox       = require('dox'),
    formatter = require('../lib/dox-foundation');

/**
 * Options & Defaults
 */

var ignoredDirs = 'test,public,static,views,templates';

program
  .version(formatter.version)
  .option('-r, --raw', 'output \'raw\' comments, leaving the markdown intact')
  .option('-d, --debug', 'output parsed comments for debugging')
  .option('-t, --title <string>', 'The title for the page produced')
  .option('-s, --source <source>', 'The folder which should get parsed')
  .option('-i, --ignore <directories>', 'Comma seperated list of directories to ignore. Default: ' + ignoredDirs)
  .option('-T, --target <target>', 'The folder which will contain the results. Default: <process.cwd()>/docs')
  .option('--template <jade template>', 'The jade template file to use');

// examples
program.on('--help', function(){
  console.log('  Examples:');
  console.log('');
  console.log('    # stdin');
  console.log('    $ dox-foundation > myfile.html');
  console.log('');
  console.log('    # operates over stdio');
  console.log('    $ dox-foundation < myfile.js > myfile.html');
  console.log('');
  console.log('    # parse a whole folder');
  console.log('    $ dox-foundation --source ./lib --target ./docs');
});

// parse argv
program.parse(process.argv);

if(program.template){
  formatter.template = fs.readFileSync(program.template).toString();
}

// If the program specifies a source directory
if (program.source) {
  var target  = path.resolve(process.cwd(), program.target) || process.cwd() + '/docs',
      source  = path.resolve(process.cwd(), program.source),
      ignore  = program.ignore || ignoredDirs;

  // Cleanup and turn into an array the ignoredDirs
  ignore = ignore.trim().replace(' ','').split(',');

  // Find, cleanup and validate all potential files
  var files = formatter.collectFiles(source, ignore);
  formatter.createTargetFolders(target, files);

  // Dox all those files
  files = formatter.doxFiles(source, target, { raw: program.raw }, files)

  files.push({
    sourceFile: 'index.html',
    targetFile: 'index.html',
    dox: []
  });

  var options = {
    title: program.title || require(process.cwd() + '/package').name
  };

  // Render and save each file
  files.forEach(function(file) {
    options.subTitle = file.sourceFile;

    var output = formatter.parse(file, files, options);

    fs.writeFileSync(target + '/' + file.targetFile, output);
  });

} else {
  // process stdin

  var buf = '';
  process.stdin.setEncoding('utf8');
  process.stdin.on('data', function(chunk){ buf += chunk; });
  process.stdin.on('end', function(){
    // Run the buffer through Dox
    var obj = dox.parseComments(buf, { raw: program.raw });
    // If debug, just throw out the dox json
    if (program.debug) {
      process.stdout.write(util.inspect(obj, false, Infinity, true) + '\n');
    } else {
      // Run the json to be formatted and dumped to stdout
      var output = formatter.parse(obj, { title: program.title, folderStructure: null });
      process.stdout.write(output);
    }
  }).resume();
}
